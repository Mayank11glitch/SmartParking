<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Parking ‚Äî Reserve Spot</title>
  <link rel="stylesheet" href="styles.css">


</head>

<body>

  <div class="bg-blob blob-1" style="opacity: 0.2;"></div>
  <div class="bg-blob blob-2" style="opacity: 0.2;"></div>

  <header>
    <div class="container">
      <div class="brand">
        <div class="brand-logo">SP</div>
        <div>
          <div>Smart Parking</div>
          <div style="font-size:0.8rem;color:var(--text-muted);font-weight:400">Reserve</div>
        </div>
      </div>
      <div style="display:flex;gap:12px;">
        <button class="btn btn-outline" onclick="window.location.href='dashboard.html'">Back</button>
        <button class="btn btn-outline" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="glass-panel" style="padding: 32px; border-radius:16px;">
      <h1 style="margin-bottom:8px;">Reserve a Parking Spot</h1>
      <p style="color:var(--text-muted);margin-bottom:32px;">Choose a slot, set time and vehicle details.</p>

      <div class="split-section" style="padding:0; gap:32px; grid-template-columns: 2fr 1fr;">
        <!-- Form -->
        <form id="reserveForm">
          <div class="form-group">
            <label class="form-label">Spot ID</label>
            <input id="spotId" class="form-control" placeholder="e.g. A101" required>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="form-group">
              <label class="form-label">Reservation Date</label>
              <input id="date" type="date" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">Start Time</label>
              <input id="time" type="time" class="form-control" required>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="form-group">
              <label class="form-label">Duration</label>
              <select id="durationSelect" class="form-control" onchange="updateDuration()">
                <option value="30">30 minutes</option>
                <option value="60" selected>1 hour</option>
                <option value="90">1.5 hours</option>
                <option value="120">2 hours</option>
                <option value="180">3 hours</option>
                <option value="240">4 hours</option>
                <option value="300">5 hours</option>
                <option value="360">6 hours</option>
                <option value="custom">Custom...</option>
              </select>
            </div>
            <div class="form-group" id="customDurationDiv" style="display:none;">
              <label class="form-label">Custom Duration (minutes)</label>
              <input id="customMinutes" type="number" min="15" max="1440" step="15" class="form-control"
                placeholder="e.g., 45">
            </div>
            <div class="form-group" id="vehicleDiv">
              <label class="form-label">Vehicle Number</label>
              <input id="vehicle" class="form-control" placeholder="MH12AB1234" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Floor (Optional)</label>
            <select id="floor" class="form-control">
              <option value="">Auto detect</option>
              <option value="1">Floor 1</option>
              <option value="2">Floor 2</option>
              <option value="3">Floor 3</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Payment Method</label>
            <select id="payMethod" class="form-control" onchange="handlePaymentMethodChange()">
              <option value="pay-at-exit">Pay at exit</option>
              <option value="upi">UPI Payment (PhonePe/GPay/Paytm)</option>
            </select>
          </div>

          <!-- UPI Payment Section -->
          <div id="upiSection" style="display:none; margin-top:16px;">
            <div class="glass-panel"
              style="padding:20px; background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.3); border-radius:12px;">
              <!-- Payment Info -->
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
                <div style="font-size:2rem;">üí≥</div>
                <div>
                  <div style="font-weight:600; font-size:1.1rem;">UPI Payment</div>
                  <div style="font-size:0.85rem; color:var(--text-muted);">Pay via PhonePe, GPay, Paytm, or any UPI app
                  </div>
                </div>
              </div>

              <!-- Amount Display -->
              <div style="background:rgba(255,255,255,0.1); padding:16px; border-radius:8px; margin-bottom:16px;">
                <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:4px;">Amount to Pay</div>
                <div style="font-size:2rem; font-weight:700; color:#22c55e;">‚Çπ<span id="upiAmount">0</span></div>
              </div>

              <!-- UPI ID Display -->
              <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:16px;">
                <div style="font-size:0.85rem; color:var(--text-muted); margin-bottom:4px;">Pay to UPI ID</div>
                <div style="font-weight:600; font-family:monospace; font-size:1.1rem;">9325697298@ibl</div>
                <button type="button" onclick="copyUPIId()" class="btn btn-outline"
                  style="margin-top:8px; padding:4px 12px; font-size:0.85rem;">
                  üìã Copy UPI ID
                </button>
              </div>

              <!-- Pay Button -->
              <button type="button" class="btn btn-primary" onclick="initiateUPIPayment()"
                style="width:100%; margin-bottom:16px;">
                <span style="margin-right:8px;">üí≥</span> Pay ‚Çπ<span id="upiPayAmount">0</span> via UPI
              </button>

              <!-- Transaction ID Input -->
              <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:16px;">
                <div style="font-size:0.9rem; margin-bottom:8px;">
                  ‚ÑπÔ∏è After completing payment, enter your Transaction ID below:
                </div>
                <div class="form-group" style="margin-bottom:0;">
                  <label class="form-label">Transaction ID / UPI Reference Number *</label>
                  <input id="upiTransactionId" class="form-control" placeholder="e.g., 123456789012" maxlength="20">
                  <div style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">
                    Find this in your UPI app's transaction history
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:12px;margin-top:24px;">
            <button class="btn btn-primary" type="submit">Confirm Reservation</button>
            <button type="button" class="btn btn-outline" onclick="previewCalc()">Preview Cost</button>
          </div>
        </form>

        <!-- Summary -->
        <div class="glass-panel" style="padding:24px; border-radius:12px; background:rgba(255,255,255,0.02);">
          <h3 style="margin-bottom:16px;">Summary</h3>
          <div style="display:flex;flex-direction:column;gap:12px;font-size:0.95rem;color:var(--text-muted);">
            <div style="display:flex;justify-content:space-between;"><span>User:</span> <strong id="resUser"
                style="color:white">‚Äî</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Spot:</span> <strong id="resSpot"
                style="color:white">‚Äî</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Date:</span> <strong id="resDate"
                style="color:white">‚Äî</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Dur:</span> <strong id="resHours"
                style="color:white">‚Äî</strong></div>
            <div style="display:flex;justify-content:space-between;"><span>Vehicle:</span> <strong id="resVehicle"
                style="color:white">‚Äî</strong></div>
            <div style="height:1px;background:var(--card-border);margin:8px 0;"></div>
            <div style="display:flex;justify-content:space-between;"><span>Rate:</span> <strong id="resRate"
                style="color:white">‚Çπ0/hr</strong></div>
            <div style="display:flex;justify-content:space-between;font-size:1.2rem;color:white;margin-top:8px;">
              <span>Total:</span> <strong id="resTotal">‚Çπ0</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div id="confirmModal" class="modal-backdrop" style="display:none">
    <div class="modal-content">
      <div id="ticketContent">
        <h3 style="text-align:center;margin-bottom:20px;">Reservation Confirmed</h3>
        <div style="background:white;color:black;padding:20px;border-radius:12px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>ID:</span> <strong
              id="ticketId">‚Äî</strong></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>User:</span> <strong
              id="ticketUser">‚Äî</strong></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Spot:</span> <strong
              id="ticketSpot">‚Äî</strong></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Time:</span> <strong
              id="ticketWhen">‚Äî</strong></div>
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;"><span>Duration:</span> <strong
              id="ticketDur">‚Äî</strong></div>
          <div style="margin-top:20px;text-align:center;">
            <img id="ticketQR" src="" alt="QR" style="width:150px;height:150px;">
          </div>
        </div>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px;">
        <button class="btn btn-outline" onclick="closeModal()">Close</button>
        <button class="btn btn-outline" onclick="window.location.href='myreservations.html'">My Reservations</button>
        <button class="btn btn-primary" onclick="printTicket()">Print Ticket</button>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // Keeping original logic
    function toast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.style.opacity = 1; t.style.transform = 'translateY(0)'; t.style.pointerEvents = 'auto'; setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateY(-20px)'; t.style.pointerEvents = 'none'; }, 2400); }

    const current = JSON.parse(localStorage.getItem('sp_current_user_v1') || 'null');
    if (!current) { window.location.href = 'login.html'; }
    else { document.getElementById('resUser').textContent = current.firstName || current.email; }

    function qs(name) { const p = new URLSearchParams(location.search); return p.get(name); }
    const spotParam = qs('spot'); if (spotParam) document.getElementById('spotId').value = spotParam;
    const floorParam = qs('floor'); if (floorParam) document.getElementById('floor').value = floorParam;

    const priceMap = { 'A101': 40, 'A102': 30, 'A103': 30, 'A104': 40, 'B201': 450, 'C302': 30 };
    function getRate(spot) { return priceMap[spot] || 500; }

    // Handle duration selection
    function updateDuration() {
      const select = document.getElementById('durationSelect');
      const customDiv = document.getElementById('customDurationDiv');
      const vehicleDiv = document.getElementById('vehicleDiv');

      if (select.value === 'custom') {
        customDiv.style.display = 'block';
        vehicleDiv.style.gridColumn = '1 / -1'; // Span full width
      } else {
        customDiv.style.display = 'none';
        vehicleDiv.style.gridColumn = 'auto';
      }

      previewCalc();
    }

    // Get selected duration in minutes
    function getDurationMinutes() {
      const select = document.getElementById('durationSelect');
      if (select.value === 'custom') {
        const customMin = parseInt(document.getElementById('customMinutes').value || '0');
        return customMin > 0 ? customMin : 60; // Default to 60 if invalid
      }
      return parseInt(select.value);
    }

    function previewCalc() {
      const spot = (document.getElementById('spotId').value || '').trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const durationMin = getDurationMinutes();
      const vehicle = document.getElementById('vehicle').value || '';
      const ratePerHour = getRate(spot);

      // Calculate based on minutes (pro-rated)
      const hours = durationMin / 60;
      const total = Math.ceil(ratePerHour * hours); // Round up to nearest rupee

      // Format duration display
      const durationDisplay = durationMin >= 60
        ? `${Math.floor(durationMin / 60)}h ${durationMin % 60}m`.replace(' 0m', '')
        : `${durationMin}m`;

      document.getElementById('resSpot').textContent = spot || '‚Äî';
      document.getElementById('resDate').textContent = (date ? date : '‚Äî') + (time ? ' ' + time : '');
      document.getElementById('resHours').textContent = durationDisplay;
      document.getElementById('resVehicle').textContent = vehicle || '‚Äî';
      document.getElementById('resRate').textContent = '‚Çπ' + ratePerHour + '/hr';
      document.getElementById('resTotal').textContent = '‚Çπ' + total;
      toast('Price preview updated');

      // Also update UPI amount if UPI is selected
      if (document.getElementById('payMethod').value === 'upi') {
        updateUPIAmount();
      }
    }

    // ========== UPI PAYMENT FUNCTIONS ==========

    // Show/hide UPI section based on payment method
    function handlePaymentMethodChange() {
      const payMethod = document.getElementById('payMethod').value;
      const upiSection = document.getElementById('upiSection');

      if (payMethod === 'upi') {
        upiSection.style.display = 'block';
        updateUPIAmount();
      } else {
        upiSection.style.display = 'none';
      }
    }

    // Update UPI amount display
    function updateUPIAmount() {
      const spot = document.getElementById('spotId').value.trim();
      const durationMin = getDurationMinutes();
      const ratePerHour = getRate(spot);
      const hours = durationMin / 60;
      const total = Math.ceil(ratePerHour * hours);

      document.getElementById('upiAmount').textContent = total;
      document.getElementById('upiPayAmount').textContent = total;
    }

    // Copy UPI ID to clipboard
    function copyUPIId() {
      const upiId = '9325697298@ibl';
      navigator.clipboard.writeText(upiId).then(() => {
        toast('‚úÖ UPI ID copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = upiId;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        toast('‚úÖ UPI ID copied!');
      });
    }

    // Generate UPI payment link
    function generateUPILink(amount, transactionNote) {
      const upiId = '9325697298@ibl'; // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL UPI ID
      const name = 'Smart Parking';

      // UPI Deep Link Format (works with all UPI apps)
      const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(name)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

      return upiUrl;
    }

    // Initiate UPI payment
    function initiateUPIPayment() {
      const spot = document.getElementById('spotId').value.trim();
      const durationMin = getDurationMinutes();
      const ratePerHour = getRate(spot);
      const hours = durationMin / 60;
      const total = Math.ceil(ratePerHour * hours);

      if (!spot) {
        toast('‚ö†Ô∏è Please select a parking spot first');
        return;
      }

      const transactionNote = `Parking ${spot} - ${durationMin}min`;
      const upiLink = generateUPILink(total, transactionNote);

      // Try to open UPI app
      const opened = window.open(upiLink, '_blank');

      if (!opened) {
        // Fallback: try location.href
        window.location.href = upiLink;
      }

      toast('üí≥ Opening UPI app for payment...');

      // Show instruction after a moment
      setTimeout(() => {
        alert('üì± Complete the payment in your UPI app, then return here and enter the Transaction ID to confirm your reservation.');
      }, 1000);
    }

    function saveReservation(res) {
      const key = 'sp_reservations_v1';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      list.push(res); localStorage.setItem(key, JSON.stringify(list));
    }

    function hasConflict(spot, date, startEpoch, endEpoch) {
      const key = 'sp_reservations_v1';
      const list = JSON.parse(localStorage.getItem(key) || '[]');
      for (const r of list) {
        if (r.status === 'cancelled') continue;
        if (r.spot.toLowerCase() !== spot.toLowerCase()) continue;
        if (r.date !== date) continue;
        const existsS = Date.parse(r.date + 'T' + r.time);
        // Support both durationMin (new) and hours (old) formats
        const durationMs = r.durationMin ? r.durationMin * 60000 : (r.hours || 1) * 3600000;
        const existsE = existsS + durationMs;
        if (startEpoch < existsE && existsS < endEpoch) return r;
      }
      return null;
    }

    document.getElementById('reserveForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const spot = document.getElementById('spotId').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const durationMin = getDurationMinutes(); // Get duration in minutes
      const vehicle = document.getElementById('vehicle').value.trim();
      const floor = document.getElementById('floor').value;
      const payMethod = document.getElementById('payMethod').value;

      if (!spot || !date || !time || !vehicle) return toast('Please fill all fields');

      // Validate custom duration
      if (document.getElementById('durationSelect').value === 'custom' && durationMin < 15) {
        return toast('Minimum duration is 15 minutes');
      }

      // UPI Payment Validation
      if (payMethod === 'upi') {
        const transactionId = document.getElementById('upiTransactionId').value.trim();

        if (!transactionId) {
          alert('‚ö†Ô∏è Please complete UPI payment first and enter the Transaction ID');
          return;
        }

        if (transactionId.length < 8) {
          alert('‚ö†Ô∏è Please enter a valid Transaction ID (minimum 8 characters)');
          return;
        }
      }

      const sEpoch = Date.parse(date + 'T' + time);
      const eEpoch = sEpoch + durationMin * 60000; // Convert minutes to milliseconds

      const conflict = hasConflict(spot, date, sEpoch, eEpoch);
      if (conflict) return alert('Conflict: Spot occupied by ' + (conflict.userName || 'someone'));

      const ratePerHour = getRate(spot);
      const hours = durationMin / 60;
      const total = Math.ceil(ratePerHour * hours);

      const res = {
        id: 'res_' + Date.now(),
        userId: current.id,
        userName: current.firstName,
        spot,
        date,
        time,
        durationMin: durationMin,  // Store in minutes
        hours: hours,              // Store decimal hours for compatibility
        vehicle,
        floor,
        rate: ratePerHour,
        total,
        payMethod,
        created: new Date().toISOString()
      };

      // Add UPI payment details if UPI was selected
      if (payMethod === 'upi') {
        const transactionId = document.getElementById('upiTransactionId').value.trim();
        res.upiTransactionId = transactionId;
        res.paymentStatus = 'paid';
        res.paymentMethod = 'UPI';
      } else {
        res.paymentStatus = 'pending';
        res.paymentMethod = 'Pay at Exit';
      }

      // Save to localStorage for backward compatibility
      saveReservation(res);

      // üî• FIREBASE INTEGRATION
      console.log('üî• Starting Firebase integration...');
      console.log('   window.database exists:', !!window.database);
      console.log('   Spot:', spot);
      console.log('   User ID:', current.id);

      try {
        const uid = localStorage.getItem("uid") || current.id;
        const email = localStorage.getItem("userEmail") || current.email;

        if (window.database) {
          console.log('‚úÖ Firebase database is available');

          // Map spot ID to slot key
          // Map spot ID to slot key
          function getSlotKey(spotId) {
            // Firebase keys match the Spot IDs directly
            // e.g. "slots/A101"
            return spotId;
          }

          const slotKey = getSlotKey(spot);
          console.log('üîë Mapped spot', spot, 'to slot key:', slotKey);

          if (slotKey) {
            console.log('üì¶ Importing Firebase functions...');
            const { ref, get, update, push, set } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
            console.log('‚úÖ Firebase functions imported');

            const slotRef = ref(window.database, "slots/" + slotKey);
            const slotSnap = await get(slotRef);
            console.log('üìä Slot data:', slotSnap.exists() ? slotSnap.val() : 'NOT FOUND');

            const slotData = slotSnap.val();
            if (slotData?.occupied === true) {
              alert("Slot already occupied in Firebase");
              return;
            }
            if (slotData?.booked === true) {
              alert("Slot already booked by another user");
              return;
            }

            // 1Ô∏è‚É£ Mark slot as BOOKED (not occupied yet - waiting for car)
            console.log('1Ô∏è‚É£ Marking slot as booked...');
            console.log('   Duration (minutes):', res.durationMin);
            await update(slotRef, {
              booked: true,
              occupied: false,  // Will be set to true by ESP32 when car detected
              userId: uid,
              durationMin: res.durationMin,  // Use actual minutes from reservation
              startTime: 0,  // ESP32 will set this when car arrives
              timerActive: false  // ESP32 will activate when car detected
            });
            console.log('‚úÖ Slot marked as booked with', res.durationMin, 'minutes');

            // 2Ô∏è‚É£ Save booking to Firebase
            console.log('2Ô∏è‚É£ Creating booking record...');
            const bookingRef = push(ref(window.database, "bookings"));
            await set(bookingRef, {
              userId: uid,
              email: email,
              spot: spot,
              slotKey: slotKey,
              vehicle: vehicle,
              date: date,
              time: time,
              hours: hours,
              durationMin: durationMin,
              status: "ACTIVE",
              createdAt: new Date().toISOString()
            });

            console.log("‚úÖ Reservation saved to Firebase successfully!");
          } else {
            console.warn('‚ö†Ô∏è Slot key is null - spot not mapped:', spot);
          }
        } else {
          console.error('‚ùå window.database is not available!');
          console.log('   This means Firebase did not initialize properly');
        }
      } catch (error) {
        console.error("‚ùå Firebase error:", error);
        console.error("   Error details:", error.message);
        console.error("   Stack:", error.stack);
        // Continue with localStorage-only reservation
      }

      // Show confirmation modal
      openModalWithReservation(res);
    });

    function openModalWithReservation(res) {
      document.getElementById('ticketId').textContent = res.id;
      document.getElementById('ticketUser').textContent = res.userName;
      document.getElementById('ticketSpot').textContent = res.spot;
      document.getElementById('ticketWhen').textContent = res.date + ' ' + res.time;
      document.getElementById('ticketDur').textContent = res.hours + 'h';

      const payload = encodeURIComponent(`RES|${res.id}|${res.spot}`);
      document.getElementById('ticketQR').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${payload}`;
      document.getElementById('confirmModal').style.display = 'flex';
      toast('Reservation Confirmed!');
    }

    window.closeModal = function () { document.getElementById('confirmModal').style.display = 'none'; window.location.href = 'dashboard.html'; }

    window.printTicket = function () {
      const c = document.getElementById('ticketContent').innerHTML;
      const w = window.open('', '_blank', 'width=400,height=600');
      const htmlContent = '<html><body style="font-family:sans-serif;padding:20px;">' + c + '<' + '/body><' + '/html>';
      w.document.write(htmlContent);
      w.document.close();
      setTimeout(function () { w.print(); }, 500);
    }

    window.logout = function () { localStorage.removeItem('sp_current_user_v1'); window.location.href = 'login.html'; }

    ['spotId', 'date', 'time', 'hours', 'vehicle', 'floor'].forEach(id => document.getElementById(id).addEventListener('input', previewCalc));
    previewCalc();
  </script>
  <canvas id="flickering-grid"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;"></canvas>
  <script src="js/flickering-grid.js"></script>
  <script src="js/init-grid.js"></script>

  <script type="module">
    // üî• Firebase Initialization for Reservation System
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHrwLfSCIuLvC7VqhpX-u_jUaW2AwDauU",
      authDomain: "smartparkingfinal-8c79e.firebaseapp.com",
      databaseURL: "https://smartparkingfinal-8c79e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartparkingfinal-8c79e",
      storageBucket: "smartparkingfinal-8c79e.firebasestorage.app",
      messagingSenderId: "855138079664",
      appId: "1:855138079664:web:78fd5da08725e5d9abbc75"
    };

    // Initialize Firebase and make database available globally
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    window.database = database;

    console.log("üî• Firebase initialized for Reservation page");
  </script>
</body>

</html>